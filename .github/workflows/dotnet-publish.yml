name: Build and Publish .NET App

permissions:
  contents: read

on:
  workflow_dispatch:

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  build:
    if: github.ref == 'refs/heads/main'
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
      previous_tag: ${{ steps.tag.outputs.previous_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup .NET 10.x
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props', '**/global.json', '**/nuget.config') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Determine next release tag
        id: tag
        shell: pwsh
        run: |
          git fetch --tags --force
          $tagPattern = '^v(\d+)(?:\.(\d+))?(?:\.(\d+))?$'
          $latestTag = git tag --list 'v*' --sort=-v:refname | Where-Object { $_ -match $tagPattern } | Select-Object -First 1

          if (-not $latestTag) {
            $newTag = 'v0.1.0'
          } else {
            $matches = [regex]::Match($latestTag, $tagPattern)
            $major = [int]$matches.Groups[1].Value
            $minor = if ($matches.Groups[2].Success) { [int]$matches.Groups[2].Value } else { 0 }
            $patch = if ($matches.Groups[3].Success) { [int]$matches.Groups[3].Value } else { 0 }
            $newTag = "v$major.$minor.$($patch + 1)"
          }

          "new_tag=$newTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "previous_tag=$latestTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test
        run: dotnet test --no-build --verbosity normal

      - name: Publish single-file EXE
        run: dotnet publish CmpInf.csproj --configuration Release --runtime win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true --output publish

      - name: Upload published artifact
        uses: actions/upload-artifact@v4
        with:
          name: CmpInf-win-x64-singlefile
          path: publish/*.exe
          if-no-files-found: error

  release:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Ensure release tag exists
        id: ensure_tag
        shell: pwsh
        run: |
          $tag = '${{ needs.build.outputs.new_tag }}'
          git fetch --tags --force
          $existingTag = git tag --list $tag

          if (-not $existingTag) {
            git config user.name 'github-actions[bot]'
            git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
            git tag -a $tag ${{ github.sha }} -m "Release $tag"
            git push origin "refs/tags/$tag"
          }

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Generate release notes
        id: notes
        shell: pwsh
        run: |
          $previousTag = '${{ needs.build.outputs.previous_tag }}'
          if ([string]::IsNullOrWhiteSpace($previousTag)) {
            $rangeText = 'Initial release (no previous tag found).'
            $changes = git log -n 20 --pretty=format:'- %h %s'
          } else {
            $rangeText = "Changes since $previousTag."
            $changes = git log "$previousTag..$env:GITHUB_SHA" --pretty=format:'- %h %s'
          }

          if (-not $changes) {
            $changes = '- No code changes found.'
          }

          "range_text=$rangeText" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "changes<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          $changes | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Download artifact
        uses: actions/download-artifact@v8
        with:
          name: CmpInf-win-x64-singlefile
          path: publish

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ensure_tag.outputs.tag }}
          name: Release ${{ steps.ensure_tag.outputs.tag }}
          make_latest: true
          files: publish/*.exe
          body: |
            Automated release for commit `${{ github.sha }}`.

            ${{ steps.notes.outputs.range_text }}

            ## Changes
            ${{ steps.notes.outputs.changes }}

            build by [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
